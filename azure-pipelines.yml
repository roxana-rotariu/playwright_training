trigger:
  - main

pool:
  vmImage: ubuntu-latest

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '18.x'

  - script: |
      npm ci
      npx playwright install --with-deps
    displayName: Install dependencies

  - script: |
      npx playwright test
    displayName: Run Playwright tests

  - script: |
      npx allure-commandline generate allure-results -o allure-site --clean
    displayName: Generate Allure report

  # -----------------------------
  # Deploy Allure â†’ gh-pages
  # -----------------------------
  - script: |
      git config user.name "azure-pipelines"
      git config user.email "ci@azure.devops"

      if git ls-remote --exit-code --heads origin gh-pages; then
        git fetch origin gh-pages
        git checkout gh-pages
      else
        git checkout --orphan gh-pages
      fi

      git rm -rf . || true
      cp -r allure-site/* .

      git add .
      git commit -m "chore: update Allure report [ci skip]" || echo "No changes"
      git push origin gh-pages --force
    displayName: Publish Allure to gh-pages
